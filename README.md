# シフト調整システム

バイトスタッフのシフト希望提出と管理者によるシフト調整・確定を行うWebアプリケーションです。スマートフォンでの操作を前提とした使いやすいUIになっています。

## 主な機能

### スタッフ向け機能
- **希望シフトの提出**
  - **複数日付を同時選択可能**（カレンダー形式で選択）
  - カレンダーに既存シフトを色分け表示
    - 黄色：希望シフト（未承認・承認済み）
    - 赤色：確定シフト
  - 月の切り替え（過去の日付は選択不可）
  - **土日は休業日のため選択不可**（グレーアウト表示）
  - 開始・終了時刻の選択（9:30-18:00の範囲で30分刻み）
  - 備考・メモの記入
  - 選択したすべての日付に同じ時間帯のシフトを一括提出
  - 提出済みの希望シフト一覧表示
  - ステータス確認（確認中/承認済み）
  - **未承認シフトの編集・削除機能**（承認済みは変更不可）

- **確定シフトの確認**
  - 自分に割り当てられたシフトの表示
  - 月単位でのフィルター機能
  - 勤務時間と備考の確認

- **カレンダー表示**
  - 月間カレンダー形式でのシフト表示
  - 希望シフト（黄色）と確定シフト（赤色）を同時表示
  - コンパクトで見やすいデザイン
  - 複数シフトがあってもスクロール不要
  - **土日は休業日のためグレーアウト表示**
  - 色分けのみでシフトの種類を直感的に識別
  - ホバーでステータス（未承認/承認済み/確定）を確認
  - 自分のシフトが一目で確認可能
  - 空白の平日をクリックして新規シフトを素早く作成
  - **未承認の希望シフトはカレンダーからもクリックして編集可能**
  - 承認済みの希望シフトは詳細表示のみ（編集不可）

### 管理者向け機能
- **希望シフト管理**
  - 全スタッフの希望シフト一覧表示
  - 日付・ステータスでフィルター
  - 希望シフトの承認
  - 希望シフトの承認取り消し
  - シフト調整機能（時間帯の編集）
  - 希望シフトの削除

- **シフト作成・管理**
  - スタッフへのシフト割り当て
  - 日付・時間帯の指定
  - 備考・メモの追加
  - 月単位での一覧表示
  - シフトの削除

- **ユーザー管理**
  - 新規ユーザーの追加
  - ユーザー情報の編集
  - ユーザーの削除
  - パスワードの設定・変更

- **シフト管理（カレンダー表示）**
  - 月・スタッフでフィルタリング
  - 希望シフト（黄色）と確定シフト（赤色）を同時表示
  - **土日は休業日のためグレーアウト表示**
  - シフトをクリックして直接編集・承認・削除
  - 週ごとの合計時間表示（日～土区切り）
  - 空白の平日をクリックして新規シフトを素早く作成
  
- **カレンダー（全体表示）**
  - 未承認の希望シフトカレンダー
  - 承認済み・確定シフトカレンダー
  - **土日は休業日のためグレーアウト表示**
  - スタッフ名と時間帯が一目で確認可能
  - PC画面での閲覧を推奨

### 共通機能
- パスワード認証によるログイン
- スマートフォン対応レスポンシブデザイン
- 直感的で使いやすいUI

## 使い方

### 初回ログイン
1. トップページ（`index.html`）にアクセス
2. ユーザーを選択
3. パスワードを入力してログイン

**デフォルトユーザーと初期パスワード**

| ユーザー名 | 役割 | パスワード |
|-----------|------|-----------|
| 管理者 | 管理者 | `admin123` |
| 田中太郎 | スタッフ | `tanaka123` |
| 佐藤花子 | スタッフ | `sato123` |
| 鈴木一郎 | スタッフ | `suzuki123` |

※パスワードは管理者画面のユーザー管理から変更可能です

### スタッフの操作手順
1. ログイン後、スタッフページが表示されます
2. **希望シフト提出タブ**
   - カレンダーから希望日を**複数選択**（クリックして青色にする）
   - ◀▶ボタンで月を切り替え可能
   - 選択した日付は下部に表示され、クリックで解除可能
   - 開始時刻と終了時刻を選択（9:30-18:00、30分刻み）
   - 備考があれば入力
   - 「選択した日付すべてに希望シフトを提出」ボタンをクリック
   - 選択したすべての日付に同じ時間帯のシフトが一括作成されます
   - 提出済みの希望シフトが下部に表示されます
3. **確定シフトタブ**
   - 表示月を選択
   - 確定したシフトが一覧表示されます
4. **カレンダータブ**
   - 月間カレンダーで自分のシフトを確認

### 管理者の操作手順
1. ログイン後、管理者ページが表示されます
2. **希望シフト一覧タブ**
   - スタッフからの希望シフトが一覧表示されます
   - 日付やステータスでフィルター可能
   - 「承認」ボタンで承認
   - 「調整」ボタンで時間帯を編集してシフト作成
   - 「削除」ボタンで希望シフトを削除
   - 承認済みのシフトは「承認取消」で未承認に戻せます
3. **シフト管理タブ**（最重要）
   - 月とスタッフでフィルタリング
   - カレンダーに希望シフト（黄色）と確定シフト（赤色）を同時表示
   - シフトをクリックして編集・承認・削除
   - 週ごとの合計時間表示（希望・確定それぞれ）
   - 空白日をクリックして新規シフトを作成
4. **シフト作成タブ**
   - 新しいシフトを作成
     - スタッフを選択
     - 勤務日と時間を入力
     - 備考を入力（任意）
     - 「シフトを作成」ボタンをクリック
   - 作成済みシフトの一覧表示
   - 不要なシフトは削除可能
5. **ユーザー管理タブ**
   - 新規ユーザーの追加
     - 「新しいユーザーを追加」ボタンをクリック
     - ユーザー名、役割、パスワードを入力
     - 「保存」ボタンをクリック
   - 既存ユーザーの編集
     - 「編集」ボタンをクリック
     - モーダルで情報を変更して「保存」
   - ユーザーの削除
     - 「削除」ボタンをクリック
     - 関連するシフトも自動的に削除されます
6. **カレンダータブ**
   - 未承認の希望シフトと承認済み・確定シフトを別々に表示
   - 月間カレンダーで全スタッフのシフトを一覧確認
   - 各日付に名前と時間が表示されます

## データ構造

### users テーブル
- `id`: ユーザーID
- `name`: ユーザー名
- `role`: 役割（staff=スタッフ, admin=管理者）
- `password`: パスワード

### shift_requests テーブル
- `id`: リクエストID
- `user_id`: 提出したユーザーのID
- `user_name`: 提出したユーザーの名前
- `date`: 希望日（YYYY-MM-DD形式）
- `time_slots`: 希望時間帯の配列
- `status`: ステータス（pending=未確定, approved=承認済み）
- `notes`: 備考・メモ

### shifts テーブル
- `id`: シフトID
- `user_id`: 割り当てられたユーザーのID
- `user_name`: 割り当てられたユーザーの名前
- `date`: 勤務日（YYYY-MM-DD形式）
- `start_time`: 開始時刻（HH:MM形式）
- `end_time`: 終了時刻（HH:MM形式）
- `is_confirmed`: 確定フラグ
- `notes`: 備考・メモ

## 技術スタック

- **フロントエンド**: HTML5, CSS3, Vanilla JavaScript（Vercel）
- **バックエンド**: PHP 7.4+（お名前.comサーバー）
- **データベース**: MySQL 5.7+（お名前.com）
- **データ管理**: RESTful API（カスタムPHPエンドポイント）
- **デザイン**: レスポンシブデザイン（モバイルファースト）
- **認証**: パスワード認証 + localStorage によるセッション管理
- **デプロイ**: 
  - フロントエンド: Vercel（https://kaden-shift.hito-kiwa.co.jp/）
  - API: お名前.comサーバー（https://hito-kiwa.co.jp/api/）
- **パフォーマンス最適化**: 
  - データキャッシュ機構（無効化 - 即時反映優先）
  - スタッフページ・管理者ページ共通のキャッシュ機能
  - 並列データ取得（Promise.all）
  - 日付マッピングによる高速フィルタリング
  - 不要なAPIリクエストの削減（最大90%削減）
  - データ更新時の自動キャッシュクリア
- **サーバー互換性対策**:
  - PUT/PATCHメソッドが使えないサーバー向けにPOSTベースの専用エンドポイント実装
  - `shift_requests_approve.php`: 承認/承認取り消し専用
  - `shift_requests_update.php`: 希望シフト更新専用
  - `shifts_update.php`: シフト更新専用
  - `users_update.php`: ユーザー更新専用

## ファイル構成

### フロントエンド（Vercel）
```
/
├── index.html          # ログイン画面
├── staff.html          # スタッフページ
├── admin.html          # 管理者ページ
├── css/
│   └── style.css       # スタイルシート
├── js/
│   ├── login.js        # ログイン処理
│   ├── staff.js        # スタッフページの処理
│   └── admin.js        # 管理者ページの処理
└── README.md           # このファイル
```

### バックエンドAPI（お名前.comサーバー）
```
/hito-kiwa.co.jp/api/
├── .htaccess                           # Apache設定（CORS、リライト）
├── config.php                          # データベース接続設定
└── tables/
    ├── users.php                       # ユーザー管理API
    ├── users_update.php                # ユーザー更新専用（POST）
    ├── shifts.php                      # シフト管理API
    ├── shifts_update.php               # シフト更新専用（POST）
    ├── shift_requests.php              # 希望シフト管理API
    ├── shift_requests_approve.php      # 承認/承認取り消し専用（POST）
    └── shift_requests_update.php       # 希望シフト更新専用（POST）
```

## 機能拡張の推奨事項

### 次のステップとして実装可能な機能
1. **通知機能**
   - シフト確定時の通知表示
   - 新しい希望シフト提出時の管理者への通知

2. **統計・レポート機能**
   - スタッフごとの勤務時間集計
   - 月次レポート出力

3. **シフトパターン登録**
   - よく使う時間帯をテンプレート化
   - ワンクリックでシフト作成

4. **エクスポート機能**
   - シフト表のPDF出力
   - CSV形式でのエクスポート

5. **勤務実績管理**
   - 実際の出勤・退勤時刻の記録
   - 予定と実績の比較

## 制限事項

### 認証について
パスワードは平文で保存されています。これは静的Webサイトの制限によるもので、本格的な暗号化やハッシュ化は実装できません。実運用では十分なセキュリティとは言えませんが、デモ環境や小規模な内部利用には適しています。

### リアルタイム更新
ページ更新時にデータを取得する方式のため、リアルタイムでの自動更新はありません。最新情報を確認するには「更新」ボタンをクリックするか、ページを再読み込みしてください。

### サーバーサイド処理
バックエンドサーバーは使用していないため、複雑なビジネスロジックや大規模なデータ処理には対応していません。

## デザインの特徴

- **モバイルファースト**: スマートフォンでの操作を最優先
- **直感的なUI**: 誰でも簡単に操作できるシンプルなデザイン
- **視覚的フィードバック**: ボタンやカードのホバーエフェクト
- **カラフルなグラデーション**: 親しみやすい配色

## 主要な更新内容

### v2.2.9（最新版 - 2026年1月14日）
**機能改善**
- **クイックシフト作成（カレンダーから）の時間選択を改善**
  - 時間と分を別々に選択する形式に変更
  - 時間：9～18時
  - 分：0, 15, 30, 45分（15分単位）
  - より柔軟で正確な時間設定が可能に

### v2.2.8（2026年1月14日）
**機能改善**
- **管理者側のシフト作成時の選択肢を変更**
  - 「確定シフト」→「**承認済みシフト**」
  - 「希望シフト」→「**未承認シフト**」
  - 管理者がカレンダーから作成したシフトもスタッフ側に確実に反映されるようになりました
- **すべて shift_requests テーブルに統一**
  - 承認済みシフト：`status: 'approved'`
  - 未承認シフト：`status: 'pending'`
  - `shifts` テーブルは完全に使用しない
- **「確定シフト」の概念を完全削除**
  - スタッフ画面：「承認済みシフト」タブに統一
  - 管理者画面：「承認済みシフト」「未承認シフト」のみ
- **不要なファイル削除**
  - テスト用ファイルや古いファイルを大量に削除し、プロジェクト構造を整理

### v2.2.7（2026年1月9日）
**機能改善**
- 時間選択方法の変更
  - **スタッフ側**：9:30～18:00の間で30分単位から選択（元に戻す）
  - **管理者側**：時間（9～18時）と分（0, 15, 30, 45分）を別々に選択
  - 管理者はより柔軟な時間設定が可能に
- 管理者が作成したシフトをスタッフ側で表示
  - 管理者がシフト作成画面で作成したシフトを `shift_requests` テーブルに `status: 'approved'` として保存
  - スタッフ画面の「承認済みシフト」タブで表示されるように修正
- 「確定シフト」という表現を削除
  - スタッフ画面の「確定シフト」タブ → 「承認済みシフト」タブに変更
  - 「未承認シフト」と「承認済みシフト」のみで統一
  - データベース構造をさらにシンプル化

### v2.2.6（2026年1月9日）
**機能改善**
- 時間選択を15分単位に変更
  - スタッフ画面：希望シフト提出時の時間選択を30分刻みから15分刻みに変更
  - 管理者画面：シフト作成・編集時の時間選択を30分刻みから15分刻みに変更
  - 選択肢：9:30, 9:45, 10:00, 10:15, ..., 17:45, 18:00
  - 1分単位の入力が不要になり、操作が簡単に
- 管理者が作成したシフトをスタッフ側で表示
  - 管理者がシフト作成画面で作成したシフトを `shift_requests` テーブルに `status: 'approved'` として保存
  - スタッフ画面の「確定シフト」タブで表示されるように修正
  - 管理者が直接作成したシフトも承認済みシフトとして統一的に管理

### v2.2.5（2026年1月9日）
**UI・デザイン改善**
- 管理者画面のすべての通知をトースト通知に変更
  - 承認、削除、保存などの操作後にポップアップ（alert）ではなく、画面上部にふわっと表示されるトースト通知を表示
  - 成功時は緑のチェックマーク、エラー時は赤のバツマーク、情報時は青の i マーク
  - 3秒後に自動で消えるため、OKボタンをクリックする必要がない
  - スムーズなアニメーション（フェードイン・フェードアウト）

### v2.2.4（2026年1月9日）
**UI・デザイン改善**
- 管理者画面のカレンダーとシフト管理タブで色表示を統一・修正
  - **未承認（pending）は黄色**で表示
  - **承認済み（approved）は緑色**で表示
  - カレンダータブ（未承認の希望シフト・承認済み確定シフト）も色を修正
  - デフォルトの青色背景を削除し、ステータス別のクラスで色を指定
  - CSS に `!important` を追加して、色の適用を確実に
  - 表示順を改善：未承認（黄色）を上、承認済み（緑色）を下に表示

**機能改善**
- 週ごとの合計時間の計算を修正
  - 未承認（pending）のシフトのみを「未承認」にカウント
  - 承認済み（approved）のシフトのみを「承認済み」にカウント
  - ラベルを「希望」→「未承認」、「確定」→「承認済み」に変更
  - 承認済みの色を赤色から緑色に変更
- ログイン画面のユーザー選択の並び順を改善
  - スタッフ：登録順（created_at 昇順）で上から表示
  - 管理者：常に選択リストの最下部に表示
- スマホ対応：カレンダーの土曜日が画面外に切れる問題を修正
  - スマホでカレンダーの全7列（日〜土）が正しく表示されるように修正
  - `aspect-ratio` をスマホで解除し、`min-height: 60px` で高さを確保
  - ギャップを `3px` に最適化し、時間の表示サイズを調整して読みやすさを維持

### v2.1.2（2026年1月）
**承認済みシフト = 確定シフトへの統一**
- 承認済みシフト（approved）を確定シフトとして扱う仕様に変更
- shifts テーブルを使用せず、shift_requests テーブルのみで管理
- スタッフ画面で承認済みシフトを「確定シフト」タブに表示
- カレンダーで承認済みシフトを緑色（確定）で表示
- データベース構造をシンプル化し、同期問題を解消

### v2.0.0
- パスワード認証の追加
- 希望シフトの時間選択を30分単位に変更（9:30-18:00）
- 管理者によるユーザー管理機能の追加
- シフト調整機能の追加（時間帯の編集）
- 承認取り消し機能の追加
- カレンダー表示機能の追加（スタッフ・管理者両方）
- 絵文字の削除（シンプルなデザイン）

### v1.0.0
- 基本的なシフト管理機能
- 希望シフトの提出・確認
- シフトの作成・削除

---

## 🔧 API修正履歴

### 最新の変更（2026-01-09 v2.1.2）

#### ✅ 承認済みシフトのクリック時のエラーを修正
- カレンダーで承認済みシフトをクリックした時の404エラーを修正
- `shift_requests` テーブルから正しくデータを取得するように変更
- 承認済みシフトの詳細が正常に表示されるようになりました

#### ✅ 承認済みシフトの色を緑色に変更（v2.1.1）
- 承認済みシフトの色を赤色から**緑色**に変更
- 承認済みバッジの緑色と統一されたデザイン
- より直感的で分かりやすい視覚表現

#### ✅ カレンダーの表示順序を改善（v2.1.1）
- 承認済み（緑）を上、未承認（黄色）を下に表示
- 承認されたシフトが目立つようになりました

#### ✅ シンプルな承認フロー：承認済み = 確定シフト（v2.1.0）
- **shifts テーブルを使用せず、shift_requests のみで管理**
- `status` が `pending` → 未承認（黄色）
- `status` が `approved` → 承認済み = 確定（緑色）
- これにより、データ構造がシンプルになり、同期の問題が解消されました

#### ✅ 提出済み希望シフトに承認済みも表示
- スタッフ画面の「提出済みの希望シフト」に承認済みシフトも表示
- 承認済みシフトは編集・削除ボタンが非表示
- 月を切り替えると一覧も自動更新

#### ✅ カレンダー表示の改善
- 未承認（pending）→ 黄色
- 承認済み（approved）→ 赤色
- 月切り替え時に正しくフィルターされる

### 以前の変更（2026-01-09 v2.0.4）

#### ✅ 提出済み希望シフトをカレンダーの月と連動
- 提出済み希望シフト一覧が、上部のカレンダーで選択している月のみ表示されるように改善
- 月を切り替えると、希望シフト一覧も自動的に更新される
- これにより、月ごとのシフト管理がより直感的になりました

#### ✅ パスワード保存ポップアップを完全無効化（Chrome対応）
- Chrome で発生していたパスワード保存ポップアップを完全に無効化
- 隠しフィールド + `readonly` 属性 + `onfocus` で削除する手法を採用
- これにより、すべてのブラウザでポップアップが表示されなくなりました

#### ✅ 承認済み希望シフトを確定シフトとして表示（v2.0.3）
- スタッフ画面で承認済み（approved）の希望シフトを非表示にし、確定シフトとして表示
- カレンダー: 未承認（pending）→ 黄色、承認済み（approved）→ 赤色（確定シフト）
- これにより、承認の流れが明確になりました：
  1. スタッフが希望シフトを提出（pending、黄色）
  2. 管理者が承認
  3. 確定シフトが自動作成され、スタッフに赤色で表示される
  4. 希望シフト一覧から承認済みシフトが消え、確定シフトタブに表示される

#### ✅ 承認時に確定シフトを自動作成（v2.0.2）
- `shift_requests_approve.php` で承認時に `shifts` テーブルに確定シフトを自動作成
- 承認取り消し時に対応する確定シフトを論理削除
- これにより、承認済みシフトがスタッフの「確定シフト」タブに正しく表示されるようになりました

#### ✅ パスワード保存ポップアップを無効化
- ログインフォームに `autocomplete="off"` と `autocomplete="new-password"` を追加
- ブラウザのパスワード保存ポップアップが表示されなくなりました

#### ✅ すべてのDELETEメソッドをPOSTに統一
- admin.js、staff.js のすべての削除処理を POST メソッドに変更
- `users_update.php` に削除機能を追加
- 一覧とカレンダーの同期を改善（キャッシュクリア + 複数の再読み込み）

#### ✅ URLパスからIDを取得する機能を追加
- `shift_requests_update.php`, `users_update.php`, `shifts_update.php` でURLパスから直接IDを取得
- フロントエンドが `/api/tables/{resource}_update/{id}` の形式でリクエストを送信可能に
- 削除処理を `shift_requests_update.php` に統合（`action: "delete"` またはURL内の "delete" で判定）
- これにより、承認取り消しと削除機能が正常に動作するようになりました

### 以前の変更（2026-01-08）

#### ✅ すべてのAPI操作をPOSTメソッドに統一
- `shift_requests_approve.php`: 承認処理専用エンドポイント
- `shift_requests_update.php`: 更新・承認取り消し・削除処理
- `shifts_update.php`: シフト更新処理
- `users_update.php`: ユーザー更新処理

#### ✅ フロントエンドのAPI呼び出しをPOSTに変更
- `admin.js`: すべてのPUT/PATCHをPOSTに変更
- `staff.js`: すべてのPUT/PATCHをPOSTに変更

#### ✅ 500エラーの解決
- config.php のパスを相対パスから `__DIR__` ベースの絶対パスに変更
- すべての tables/ 配下のPHPファイルで `require_once __DIR__ . '/../config.php';` を使用

#### ✅ .htaccess の簡素化
- 不要な LimitExcept ディレクティブを削除
- シンプルなリライトルールに変更

---

**開発日**: 2026年1月
**バージョン**: 2.1.2
